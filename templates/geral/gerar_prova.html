{% extends "base.html" %}
{% block content %}
<h1 class="font-semibold text-3xl text-gray-900 mb-6">
    <i class="fas fa-file-signature text-purple-600"></i> Gerador de Provas (IA)
</h1>

<!-- CORREÇÃO AQUI: Mudança de 'gerar_prova_docx' para 'planos.gerar_prova_docx' -->
<form method="POST" action="{{ url_for('planos.gerar_prova_docx') }}" enctype="multipart/form-data" 
      id="form-gerar-prova" class="bg-white p-6 rounded-lg shadow-lg max-w-3xl mx-auto">
    
    <div class="space-y-6">
        
        <div>
            <label for="prova-turma-select" class="block text-lg font-semibold text-gray-700">Passo 1: Selecione a Turma</label>
            <p class="text-sm text-gray-500 mb-2">Isto irá carregar os planos de aula e atividades correspondentes.</p>
            <select id="prova-turma-select" name="turma" class="border p-2 rounded w-full focus:ring-indigo-500 focus:border-indigo-500" required>
                <option value="">-- Selecione uma Turma --</option>
                {% for turma in turmas %}
                <option value="{{ turma.id }}">{{ turma.nome }}</option>
                {% endfor %}
            </select>
        </div>

        <div id="fontes-db-container" class="space-y-4" style="display: none;">
            <label class="block text-lg font-semibold text-gray-700">Passo 2: Selecione as Fontes da Base de Dados</label>
            
            <div>
                <h4 class="font-semibold text-gray-700 mb-2">Planos de Aula (Conteúdo e Objetivos):</h4>
                <div id="planos-container" class="max-h-40 overflow-y-auto border rounded p-2 bg-gray-50 space-y-1">
                    <p class="text-gray-400 text-sm">Selecione uma turma para carregar...</p>
                </div>
            </div>
            
            <div>
                <h4 class="font-semibold text-gray-700 mb-2">Atividades Anteriores (Descrição/Questões):</h4>
                <div id="atividades-container" class="max-h-40 overflow-y-auto border rounded p-2 bg-gray-50 space-y-1">
                     <p class="text-gray-400 text-sm">Selecione uma turma para carregar...</p>
                </div>
            </div>
        </div>
        
        <div>
            <label class="block text-lg font-semibold text-gray-700">Passo 3: (Opcional) Anexe Ficheiros de Contexto</label>
            <p class="text-sm text-gray-500 mb-2">Anexe atividades, resumos ou textos (.pdf, .docx, .txt) para a IA usar como base.</p>
            <div class="space-y-2">
                <input type="file" name="fontes_externas" accept=".pdf,.docx,.txt" class="text-sm w-full border rounded p-1">
                <input type="file" name="fontes_externas" accept=".pdf,.docx,.txt" class="text-sm w-full border rounded p-1">
                <input type="file" name="fontes_externas" accept=".pdf,.docx,.txt" class="text-sm w-full border rounded p-1">
            </div>
        </div>

        <div>
            <label for="instrucoes-prova" class="block text-lg font-semibold text-gray-700">Passo 4: Dê Instruções à IA</label>
            <p class="text-sm text-gray-500 mb-2">Especifique o tipo, número de questões, dificuldade, etc.</p>
            <textarea id="instrucoes-prova" name="instrucoes_prova" rows="5" 
                      class="mt-1 border p-2 rounded w-full focus:ring-indigo-500 focus:border-indigo-500" 
                      placeholder="Ex: Crie uma prova com 5 questões de escolha múltipla (A, B, C, D) e 5 questões discursivas sobre os tópicos principais.">{{
'Crie uma prova com 5 questões de escolha múltipla (A, B, C, D) e 5 questões discursivas sobre os tópicos principais. As questões devem ter um nível de dificuldade médio.'
                   }}</textarea>
        </div>
        
        <div class="pt-4 border-t">
            <button type="submit" id="btn-gerar-prova" class="w-full bg-purple-600 text-white p-3 rounded shadow hover:bg-purple-700 font-semibold cursor-pointer text-lg">
                <i class="fas fa-magic"></i> Gerar Prova (DOCX)
            </button>
        </div>

    </div>
</form>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const turmaSelect = document.getElementById('prova-turma-select');
    const fontesDbContainer = document.getElementById('fontes-db-container');
    const planosContainer = document.getElementById('planos-container');
    const atividadesContainer = document.getElementById('atividades-container');
    const formGerarProva = document.getElementById('form-gerar-prova');
    const btnGerarProva = document.getElementById('btn-gerar-prova');

    if (!turmaSelect) return;

    turmaSelect.addEventListener('change', () => {
        const idTurma = turmaSelect.value;
        if (!idTurma) {
            fontesDbContainer.style.display = 'none';
            return;
        }

        fontesDbContainer.style.display = 'block';
        planosContainer.innerHTML = '<p class="text-gray-500 text-sm">A carregar planos...</p>';
        atividadesContainer.innerHTML = '<p class="text-gray-500 text-sm">A carregar atividades...</p>';

        fetch(`/api/fontes_turma/${idTurma}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                
                if (data.planos && data.planos.length > 0) {
                    planosContainer.innerHTML = data.planos.map(plano => `
                        <label class="block p-2 hover:bg-gray-100 rounded text-sm">
                            <input type="checkbox" name="planos_ids" value="${plano.id}" class="mr-2">
                            [${plano.data}] ${plano.titulo}
                        </label>
                    `).join('');
                } else {
                    planosContainer.innerHTML = '<p class="text-gray-500 text-sm">Nenhum plano de aula encontrado para esta turma.</p>';
                }
                
                if (data.atividades && data.atividades.length > 0) {
                    atividadesContainer.innerHTML = data.atividades.map(ativ => `
                        <label class="block p-2 hover:bg-gray-100 rounded text-sm">
                            <input type="checkbox" name="atividades_ids" value="${ativ.id}" class="mr-2">
                            [${ativ.data}] ${ativ.titulo}
                        </label>
                    `).join('');
                } else {
                    atividadesContainer.innerHTML = '<p class="text-gray-500 text-sm">Nenhuma atividade encontrada para esta turma.</p>';
                }
            })
            .catch(error => {
                console.error('Erro ao buscar fontes da turma:', error);
                planosContainer.innerHTML = '<p class="text-red-500 text-sm">Erro ao carregar planos.</p>';
                atividadesContainer.innerHTML = '<p class="text-red-500 text-sm">Erro ao carregar atividades.</p>';
            });
    });

    if (formGerarProva) {
        formGerarProva.addEventListener('submit', () => {
            if (!turmaSelect.value) {
                alert('Por favor, selecione uma turma primeiro.');
                event.preventDefault(); // Impede o envio do formulário
                return;
            }
            
            btnGerarProva.disabled = true;
            // ⭐️⭐️ CORREÇÃO DE TEXTO (Ideia 1) ⭐️⭐️
            btnGerarProva.innerHTML = '<i class="fas fa-spinner fa-spin"></i> A IA está a escrever a prova... Isto pode demorar até 10 minutos.';
        });
    }
});
</script>
{% endblock %}