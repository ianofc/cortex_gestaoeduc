{% extends "base.html" %}
{% block content %}
<h2 class="text-3xl font-bold mb-6 text-blue-700">Turma: {{ turma.nome }}</h2>

<div class="flex flex-wrap gap-4 mb-8"> 
    <a href="{{ url_for('alunos.add_aluno', id_turma=turma.id) }}" class="bg-green-600 text-white p-2 rounded shadow hover:bg-green-700 flex items-center">
        <i class="fas fa-plus mr-2"></i> Adicionar Aluno
    </a>
    <a href="{{ url_for('alunos.add_atividade', id_turma=turma.id) }}" class="bg-yellow-600 text-white p-2 rounded shadow hover:bg-yellow-700 flex items-center">
        <i class="fas fa-clipboard-list mr-2"></i> Adicionar Atividade
    </a>
    
    <a href="{{ url_for('planos.planejamento', id_turma=turma.id) }}" class="bg-indigo-600 text-white p-2 rounded shadow hover:bg-indigo-700 flex items-center">
        <i class="fas fa-calendar-alt mr-2"></i> Planejamento de Aulas
    </a>
    
    <!-- Botão Diário de Bordo Restaurado -->
    <a href="{{ url_for('planos.diario_bordo', id_turma=turma.id) }}" class="bg-teal-600 text-white p-2 rounded shadow hover:bg-teal-700 flex items-center">
        <i class="fas fa-book mr-2"></i> Diário de Bordo
    </a>
    
    <a href="{{ url_for('alunos.gradebook', id_turma=turma.id) }}" class="bg-purple-600 text-white p-2 rounded shadow hover:bg-purple-700 flex items-center">
        <i class="fas fa-th mr-2"></i> Lançamento Rápido
    </a>
    <a href="{{ url_for('alunos.exportar_relatorio', id_turma=turma.id) }}" class="bg-gray-700 text-white p-2 rounded shadow hover:bg-gray-800 flex items-center">
        <i class="fas fa-file-excel mr-2"></i> Exportar Relatório (XLSX)
    </a>
    <a href="{{ url_for('alunos.dashboard', id_turma=turma.id) }}" class="bg-red-600 text-white p-2 rounded shadow hover:bg-red-700 flex items-center">
        <i class="fas fa-chart-pie mr-2"></i> Dashboard
    </a>
</div>

<div class="flex space-x-4 mb-8 p-4 bg-gray-50 rounded-lg border">
    <a href="{{ url_for('alunos.editar_turma', id_turma=turma.id) }}" 
       class="bg-yellow-500 text-white p-2 rounded shadow hover:bg-yellow-600 transition duration-150 flex items-center">
        <i class="fas fa-edit mr-2"></i> Editar Turma
    </a>
    
    <form id="delete-turma-form" action="{{ url_for('alunos.deletar_turma', id_turma=turma.id) }}" method="POST" style="display:inline;">
        <button type="submit" 
                onclick="return confirm('ATENÇÃO: Deseja DELETAR a turma \'{{ turma.nome }}\'? Todas as atividades serão removidas e os alunos ficarão sem turma.')" 
                class="bg-red-600 text-white p-2 rounded shadow hover:bg-red-700 transition duration-150 flex items-center">
            <i class="fas fa-trash-alt mr-2"></i> Deletar Turma
        </button>
    </form>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
    
    <div class="bg-white p-6 rounded-lg shadow-lg">
        <h3 class="text-2xl font-semibold mb-4 border-b pb-2 flex justify-between items-center">
            <span><i class="fas fa-user-graduate text-blue-600 mr-2"></i> Alunos ({{ alunos_com_media | length }})</span>
        </h3>
        
        <form method="GET" action="{{ url_for('alunos.turma', id_turma=turma.id) }}" class="mb-4">
            <div class="flex">
                <input type="text" name="q" placeholder="Buscar aluno..." 
                       class="border p-2 rounded-l w-full focus:ring-blue-500 focus:border-blue-500" 
                       value="{{ q | default('', true) }}">
                <button type="submit" class="bg-blue-600 text-white p-2 rounded-r hover:bg-blue-700">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </form>
        <ul class="space-y-3 max-h-[600px] overflow-y-auto pr-2">
        
        {% for item in alunos_com_media %}
            <li class="p-3 bg-gray-50 rounded flex justify-between items-center hover:bg-blue-50 transition duration-150 border border-transparent hover:border-blue-200">
                
                <div class="flex-grow">
                    <a href="{{ url_for('alunos.aluno', id_aluno=item.aluno.id) }}" class="text-lg font-medium text-gray-800 hover:text-blue-700 block">
                        {{ item.aluno.nome }}
                    </a>
                    
                    <div class="flex items-center mt-1">
                        <span class="text-xs font-semibold uppercase tracking-wider text-gray-500 mr-2">Média:</span>
                        <span class="text-base font-bold 
                                    {% if item.media >= 6.0 %}text-blue-600
                                    {% elif item.media >= 4.0 %}text-yellow-600
                                    {% else %}text-red-600{% endif %}">
                            {{ "%.1f"|format(item.media) }}
                        </span>
                    </div>
                </div>
                
                <span class="text-xs text-gray-400 flex-shrink-0 bg-white px-2 py-1 rounded border">
                    Mat: {{ item.aluno.matricula | default("N/A", true) }}
                </span>
            </li>
        {% else %}
             <div class="text-center py-8">
                 <i class="fas fa-user-slash text-gray-300 text-4xl mb-3"></i>
                 <p class="text-gray-500">Nenhum aluno encontrado.</p>
             </div>
        {% endfor %}
        </ul>
    </div>

    <div class="bg-white p-6 rounded-lg shadow-lg">
        <h3 class="text-2xl font-semibold mb-4 border-b pb-2 flex justify-between items-center">
            <span><i class="fas fa-tasks text-yellow-600 mr-2"></i> Atividades ({{ atividades | length }})</span>
        </h3>
        
        <ul class="space-y-3 max-h-[600px] overflow-y-auto pr-2">
        {% for atividade in atividades %}
            <li class="p-4 bg-gray-50 rounded-lg border-l-4 border-yellow-500 hover:shadow-md transition duration-150" id="atividade-{{ atividade.id }}">
                
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <p class="text-lg font-bold text-gray-800">{{ atividade.titulo }}</p>
                        <span class="text-xs font-semibold px-2 py-0.5 rounded bg-yellow-100 text-yellow-800">
                            {{ atividade.tipo }}
                        </span>
                    </div>
                    <a href="{{ url_for('alunos.edit_atividade', id_atividade=atividade.id) }}" 
                       class="text-gray-400 hover:text-yellow-600 transition-colors p-1" title="Editar Atividade">
                        <i class="fas fa-pencil-alt"></i> Editar
                    </a>
                </div>
                
                <div class="flex justify-between text-sm text-gray-600 mb-3">
                    <span><i class="far fa-calendar-alt mr-1"></i> {{ atividade.data.strftime('%d/%m/%Y') if atividade.data else 'N/A' }}</span>
                    <span class="font-semibold text-gray-700">Peso: {{ atividade.peso }}</span>
                </div>
                
                <div class="mt-2 pt-2 border-t border-gray-200">
                    <p class="text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">Lançar Notas para:</p>
                    <div class="flex flex-wrap gap-2">
                    
                    {% for item in alunos_com_media %}
                        <a href="{{ url_for('alunos.registrar_presenca', id_aluno=item.aluno.id, id_atividade=atividade.id) }}" 
                           class="bg-white border border-blue-200 text-blue-700 text-xs font-medium px-2 py-1 rounded hover:bg-blue-600 hover:text-white transition-colors duration-150 flex items-center">
                            {{ item.aluno.nome.split(' ')[0] }}
                        </a>
                    {% endfor %}
                    </div>
                </div>
            </li>
        {% else %}
            <div class="text-center py-8">
                <i class="fas fa-clipboard text-gray-300 text-4xl mb-3"></i>
                <p class="text-gray-500">Nenhuma atividade cadastrada.</p>
            </div>
        {% endfor %}
        </ul>
    </div>
</div>
{% endblock %}